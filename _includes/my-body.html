<!-- Audio player for landing page -->
<audio id="backgroundAudio" preload="auto">
  <source src="/assets/audio/Winter%20Morning%20Ambience%20Sound%20Effect%20%20Copyright%20Free%20Nature%20Sounds.mp3" type="audio/mpeg">
</audio>

<script>
  // Audio player for landing page - plays on sidebar hover
  const audio = document.getElementById('backgroundAudio');
  if (audio) {
    audio.volume = 0.5;
    
    // Function to play audio
    function playAudio() {
      if (audio.paused) {
        audio.muted = false;
        audio.currentTime = 0;
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.catch(err => console.log('Audio play failed:', err));
        }
      }
    }
    
    // Fade out audio
    function fadeOutAudio() {
      if (audio && !audio.paused) {
        let currentVolume = audio.volume;
        const fadeInterval = setInterval(() => {
          currentVolume -= 0.1;
          if (currentVolume <= 0) {
            audio.pause();
            audio.volume = 0.5;
            clearInterval(fadeInterval);
          } else {
            audio.volume = currentVolume;
          }
        }, 50);
      }
    }
    
    // Stop audio on navigation
    function stopAudio() {
      if (audio) {
        audio.pause();
        audio.volume = 0.5;
      }
    }
    
    // Listen for push-state navigation (link clicks)
    const pushStateEl = document.getElementById('_pushState');
    if (pushStateEl) {
      pushStateEl.addEventListener('hy-push-state-start', fadeOutAudio);
      pushStateEl.addEventListener('hy-push-state-ready', stopAudio);
    }
    
    // Listen for hover on sidebar/drawer with debounce
    let fadeTimeout;
    setTimeout(() => {
      const drawerEl = document.querySelector('hy-drawer');
      const sidebarEl = document.querySelector('.sidebar');
      
      if (drawerEl) {
        drawerEl.addEventListener('mouseenter', () => {
          clearTimeout(fadeTimeout);
          playAudio();
        });
        drawerEl.addEventListener('mouseleave', () => {
          clearTimeout(fadeTimeout);
          fadeTimeout = setTimeout(fadeOutAudio, 1000);
        });
      }
      
      if (sidebarEl) {
        sidebarEl.addEventListener('mouseenter', () => {
          clearTimeout(fadeTimeout);
          playAudio();
        });
        sidebarEl.addEventListener('mouseleave', () => {
          clearTimeout(fadeTimeout);
          fadeTimeout = setTimeout(fadeOutAudio, 1000);
        });
      }
    }, 100);
  }
</script>

<!-- <script>
  document.querySelector('hy-push-state').setAttribute('prefetch', '');

  document.querySelectorAll('.sidebar a[href^="/"]').forEach(function (el) { 
    el.addEventListener('click', function (e) {
      if (el.pathname === window.location.pathname) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('hy-drawer').close();
      }
    });
  });
</script> -->

<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}
